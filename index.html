<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Pré-Orçamento de Voo</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />
  <style>
    body { font-family: sans-serif; }
    #map { height: 400px; margin-top: 1em; }
  </style>
</head>
<body>
  <div>
    <label for="origem">Origem:</label>
    <input id="origem" />
    <label for="destino">Destino:</label>
    <input id="destino" />
    <label for="aeronave">Aeronave:</label>
    <input id="aeronave" />
    <button id="btnGerar">Gerar Pré-Orçamento</button>
  </div>
  <div id="resultado"></div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const icaoTable = {
      SBGR: { lat: -23.435556, lng: -46.473056 },
      SBSP: { lat: -23.626111, lng: -46.656389 },
      SBRJ: { lat: -22.910556, lng: -43.163056 },
      SBGL: { lat: -22.809999, lng: -43.250556 },
      SBBR: { lat: -15.871111, lng: -47.918611 },
      SBPA: { lat: -30.000556, lng: -51.171389 }
    };

    function getCoords(icao) {
      const code = (icao || '').toUpperCase();
      return icaoTable[code];
    }

    function haversineKm(a, b) {
      const R = 6371;
      const toRad = deg => (deg * Math.PI) / 180;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const h =
        Math.sin(dLat / 2) ** 2 +
        Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLng / 2) ** 2;
      return 2 * R * Math.asin(Math.sqrt(h));
    }

    const map = L.map('map').setView([-15.78, -47.93], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    let routeLayer = null;

    function drawRouteOnMap(waypoints) {
      if (routeLayer) {
        routeLayer.remove();
        routeLayer = null;
      }
      if (waypoints.length < 2) return;
      const polyline = L.polyline(waypoints, { color: 'blue' });
      const markers = waypoints.map(p => L.marker(p));
      routeLayer = L.layerGroup([polyline, ...markers]).addTo(map);
      map.fitBounds(polyline.getBounds());
    }

    function gerarPreOrcamento() {
      const origemIcao = document.getElementById('origem').value;
      const destinoIcao = document.getElementById('destino').value;
      const aeronave = document.getElementById('aeronave').value;
      const origem = getCoords(origemIcao);
      const destino = getCoords(destinoIcao);
      if (!origem || !destino) {
        document.getElementById('resultado').innerText =
          'Informe ICAO válido para origem e destino.';
        drawRouteOnMap([]);
        return;
      }
      const distancia = haversineKm(origem, destino).toFixed(1);
      document.getElementById('resultado').innerText =
        `Distância: ${distancia} km - Aeronave: ${aeronave}`;
      const waypoints = [origem, destino];
      drawRouteOnMap(waypoints);
    }

    document
      .getElementById('btnGerar')
      .addEventListener('click', gerarPreOrcamento);

    function handleInputChange() {
      const origem = getCoords(document.getElementById('origem').value);
      const destino = getCoords(document.getElementById('destino').value);
      const waypoints = [];
      if (origem) waypoints.push(origem);
      if (destino) waypoints.push(destino);
      if (waypoints.length < 2 && routeLayer) {
        routeLayer.remove();
        routeLayer = null;
      }
    }
    document
      .getElementById('origem')
      .addEventListener('input', handleInputChange);
    document
      .getElementById('destino')
      .addEventListener('input', handleInputChange);
  </script>
</body>
</html>
