<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AVWX API Console — Substituição Rápida</title>
  <style>
    :root {
      --bg: #0b1320; --panel:#111a2b; --muted:#94a3b8; --text:#f1f5f9; --brand:#38bdf8; --ok:#22c55e; --err:#ef4444;
      --border:#1e293b; --code:#0a0f1a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1320,#0b1320 60%,#0e1726);color:var(--text);
         font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    header{padding:20px;border-bottom:1px solid var(--border);background:#0b1320;position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:18px;letter-spacing:.3px}
    .container{max-width:1100px;margin:20px auto;padding:0 16px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns: 2fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;color:var(--muted)}
    .card .content{padding:14px 16px}
    label{display:block;margin:8px 0 6px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);
      background:#0d1627;color:var(--text);outline:none}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .btn{appearance:none;border:1px solid var(--border);background:#0f1a2d;color:var(--text);
      padding:10px 14px;border-radius:12px;cursor:pointer;transition:.15s}
    .btn:hover{transform:translateY(-1px);background:#0f2139}
    .btn.brand{background:linear-gradient(90deg,#0ea5e9,#22d3ee);color:#03122a;border:none}
    .btn.brand:hover{filter:brightness(1.05)}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 10px;border-radius:10px;font-size:12px}
    .presets{display:flex;flex-wrap:wrap;gap:8px;margin-top:4px}
    .tag{padding:6px 10px;border-radius:999px;background:#10203a;border:1px solid var(--border);cursor:pointer;font-size:12px}
    .tag:hover{background:#0f2139}
    .muted{color:var(--muted)}
    .status{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1a2d}
    pre{background:var(--code);border:1px solid var(--border);border-radius:12px;padding:12px;overflow:auto}
    details{background:#0f1a2d;border:1px solid var(--border);border-radius:12px;padding:12px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    footer{opacity:.7;text-align:center;margin:18px 0}
    a{color:var(--brand);text-decoration:none}
    .danger{color:var(--err)} .success{color:var(--ok)}
  </style>
</head>
<body>
  <header>
    <h1>AVWX API Console — substituição da API em uso</h1>
    <div class="container muted" style="padding:6px 0 0 0">
      Usa cabeçalho <code>Authorization: Token …</code> em todas as chamadas. Base: <code>https://avwx.rest/api</code>.
    </div>
  </header>

  <div class="container grid">
    <section class="card">
      <h2>Requisição</h2>
      <div class="content">
        <form id="form" class="grid" style="grid-template-columns:1fr">
          <div class="row">
            <div>
              <label for="resource">Recurso (relativo ao /api)</label>
              <input id="resource" name="resource" placeholder="ex.: summary/KJFK?options=info" value="summary/KJFK?options=info" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="method">Método</label>
              <select id="method" name="method">
                <option>GET</option>
                <option>POST</option>
              </select>
            </div>
            <div>
              <label for="timeout">Timeout (s)</label>
              <input id="timeout" name="timeout" type="number" min="5" step="1" value="20" />
            </div>
          </div>

          <div>
            <label for="body">Corpo (text/plain) — use para /parse/*</label>
            <textarea id="body" name="body" placeholder="Cole aqui o relatório bruto (METAR/TAF/PIREP/AIR/SIGMET/NOTAM/NBM)"></textarea>
          </div>

          <div>
            <label>Presets rápidos</label>
            <div class="presets" id="presets">
              <span class="tag" data-res="summary/KJFK?options=info">Summary</span>
              <span class="tag" data-res="metar/KJFK?options=translate">METAR</span>
              <span class="tag" data-res="taf/KJFK?options=summary">TAF</span>
              <span class="tag" data-res="station/KJFK">Station</span>
              <span class="tag" data-res="station/near/28.1,-81?n=3">Nearest</span>
              <span class="tag" data-res="search/station?text=lihue%20hi&n=2">Search</span>
              <span class="tag" data-res="pirep/KMCO?options=info">PIREP</span>
              <span class="tag" data-res="airsigmet">AIR/SIGMET (global)</span>
              <span class="tag" data-res="airsigmet/KJFK">AIR/SIGMET Contains</span>
              <span class="tag" data-res="notam/KMCO?distance=10">NOTAM</span>
              <span class="tag" data-res="nbm/nbs/KJFK">NBM (NBS)</span>
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <button class="btn brand" id="run" type="submit">Executar</button>
            <button class="btn ghost" id="copyCurl" type="button">Copiar cURL</button>
          </div>
        </form>
      </div>
    </section>

    <section class="card">
      <h2>Resposta</h2>
      <div class="content">
        <div id="status" class="status">
          <span class="pill">Aguardando…</span>
        </div>
        <div class="muted" id="info" style="margin:8px 0 12px 0"></div>
        <div>
          <label>Corpo</label>
          <pre id="output"><code>// A resposta aparecerá aqui</code></pre>
        </div>
        <details style="margin-top:10px">
          <summary>Headers de resposta</summary>
          <pre id="headers"><code>// sem headers</code></pre>
        </details>
      </div>
    </section>
  </div>

  <div class="container">
    <footer>
      Dica: para endpoints <code>/parse/*</code> use POST + “Corpo (text/plain)”. Em produção, proteja seu token por meio de um proxy.
    </footer>
  </div>

  <script>
    // ================== CONFIG ==================
    const HOST = 'https://avwx.rest/api';
    // Token fornecido por você. A doc aceita diversos prefixos; usaremos 'Token' como nos exemplos.
    const TOKEN = 'ft5l3Qg6XULRisxePuACK46yzKo6ZWhpnLnX40Nib7s';
    // ============================================

    const $ = (sel) => document.querySelector(sel);
    const form = $('#form');
    const resourceInput = $('#resource');
    const methodInput = $('#method');
    const bodyInput = $('#body');
    const output = $('#output > code');
    const headersOut = $('#headers > code');
    const statusBox = $('#status');
    const info = $('#info');
    const copyCurlBtn = $('#copyCurl');

    // Presets
    document.getElementById('presets').addEventListener('click', (e) => {
      const el = e.target.closest('[data-res]');
      if (!el) return;
      resourceInput.value = el.dataset.res;
      // Preenche exemplos de corpo quando fizer sentido
      if (el.dataset.res.startsWith('parse/metar')) {
        bodyInput.value = 'PHKO 181753Z 28004KT 6SM HZ SCT022 27/21 A3005 RMK AO2 SLP178 T02670206 10267 20239 53009';
      }
      if (el.dataset.res.startsWith('parse/taf')) {
        bodyInput.value = 'PHKO 181735Z 1818/1918 VRB03KT P6SM FEW035 FM182000 20010KT P6SM FEW030 SCT060';
      }
      if (el.dataset.res === 'airsigmet') bodyInput.value = '';
    });

    // Helper: monta URL absoluta
    function buildUrl(resource) {
      const clean = resource.replace(/^\/+/, '');
      return `${HOST}/${clean}`;
    }

    // Helper: gera cURL
    function toCurl({ method, url, body }) {
      const parts = [
        'curl -s',
        `-X ${method}`,
        `-H "Authorization: Token ${TOKEN}"`,
        `-H "Accept: */*"`
      ];
      if (method === 'POST') {
        parts.push(`-H "Content-Type: text/plain"`);
        parts.push(`--data-binary ${JSON.stringify(body ?? '')}`);
      }
      parts.push(JSON.stringify(url));
      return parts.join(' ');
    }

    // Exibe status bonito
    function setStatus({ ok, status, timeMs, url }) {
      statusBox.innerHTML = '';
      const pill = document.createElement('span');
      pill.className = 'pill ' + (ok ? 'success' : 'danger');
      pill.textContent = `${ok ? 'OK' : 'ERRO'} • HTTP ${status}`;
      const pill2 = document.createElement('span');
      pill2.className = 'pill';
      pill2.textContent = `${(timeMs/1000).toFixed(2)}s`;
      statusBox.appendChild(pill);
      statusBox.appendChild(pill2);
      const link = document.createElement('a');
      link.href = url; link.target = '_blank'; link.rel = 'noopener';
      link.className = 'pill';
      link.textContent = 'Abrir URL';
      statusBox.appendChild(link);
    }

    // Pretty print
    function renderBody(resp, text) {
      const ctype = (resp.headers.get('content-type') || '').toLowerCase();
      // Tenta JSON
      if (ctype.includes('application/json')) {
        try {
          const obj = JSON.parse(text);
          output.textContent = JSON.stringify(obj, null, 2);
          return;
        } catch { /* cai para texto */ }
      }
      output.textContent = text;
    }

    function renderHeaders(resp) {
      const entries = [];
      resp.headers.forEach((v, k) => entries.push(`${k}: ${v}`));
      headersOut.textContent = entries.join('\n') || '// sem headers';
    }

    // Faz a chamada
    async function callApi({ resource, method, body, timeoutSec }) {
      const url = buildUrl(resource);
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), (timeoutSec ?? 20) * 1000);

      const isPost = method === 'POST';
      const fetchOpts = {
        method,
        headers: {
          // >>>>>> AUTENTICAÇÃO CONFIGURADA CORRETAMENTE <<<<<<
          'Authorization': `Token ${TOKEN}`,
          'Accept': '*/*'
        },
        signal: controller.signal
      };
      if (isPost) {
        fetchOpts.headers['Content-Type'] = 'text/plain';
        fetchOpts.body = body ?? '';
      }

      const t0 = performance.now();
      let resp, text;
      try {
        resp = await fetch(url, fetchOpts);
        text = await resp.text();
      } finally {
        clearTimeout(timeout);
      }
      const t1 = performance.now();

      setStatus({ ok: resp.ok, status: resp.status, timeMs: t1 - t0, url });
      info.innerHTML = `<span class="muted">URL:</span> <code>${url}</code>`;

      renderBody(resp, text);
      renderHeaders(resp);

      if (!resp.ok) {
        // tenta anexar corpo de erro
        output.textContent = text || `Erro HTTP ${resp.status}`;
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const resource = resourceInput.value.trim();
      const method = methodInput.value.trim();
      const body = bodyInput.value;
      const timeout = Number($('#timeout').value || 20);
      if (!resource) {
        alert('Informe o recurso (ex.: summary/KJFK?options=info)');
        return;
      }
      output.textContent = '// carregando...';
      callApi({ resource, method, body, timeoutSec: timeout }).catch(err => {
        setStatus({ ok: false, status: 'ABORT', timeMs: 0, url: buildUrl(resource) });
        output.textContent = (err && err.name === 'AbortError')
          ? 'Tempo esgotado (timeout).'
          : `Falha na requisição: ${(err && err.message) || err}`;
      });
    });

    copyCurlBtn.addEventListener('click', () => {
      const resource = resourceInput.value.trim();
      const method = methodInput.value.trim();
      const body = bodyInput.value;
      const url = buildUrl(resource);
      const cmd = toCurl({ method, url, body });
      navigator.clipboard.writeText(cmd).then(() => {
        copyCurlBtn.textContent = 'cURL copiado!';
        setTimeout(() => copyCurlBtn.textContent = 'Copiar cURL', 1200);
      });
    });
  </script>
</body>
</html>
