<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cotação • Visual Novo</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- pdfMake e html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#121831; --card-2:#0f152b;
      --text:#e8ecf6; --muted:#a7b0c3;
      --primary:#5b8cff; --primary-600:#4b78e3; --accent:#14d1c5;
      --ring: rgba(91,140,255,.35);
      --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.25); --shadow-soft:0 6px 20px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 80% -20%, #1a2246 0%, rgba(26,34,70,0) 60%),
        radial-gradient(1000px 500px at -10% 110%, #13204a 0%, rgba(19,32,74,0) 55%),
        var(--bg);
    }
    .wrap{max-width:1100px;margin:40px auto;padding:0 20px}
    .page-title{display:flex;align-items:center;gap:.8rem;margin:8px 0 22px;font-weight:700;letter-spacing:.2px;font-size:clamp(22px,2.4vw,28px)}
    .page-title .emoji{font-size:1.2em}
    .grid{display:grid;gap:16px;grid-template-columns:1.1fr .9fr}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--card) 0%,var(--card-2) 100%);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .card-h{padding:16px 18px;border-bottom:1px solid rgba(255,255,255,.07);font-weight:600;color:#dfe6ff;letter-spacing:.3px}
    .card .card-b{padding:18px}
    form{display:grid;gap:14px}
    .row{display:grid;gap:12px;grid-template-columns:repeat(12,1fr);align-items:end}
    .col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
    @media (max-width:700px){.col-6,.col-4,.col-3{grid-column:span 12}}
    label{display:block;color:var(--muted);font-size:.86rem;margin:2px 0 6px}
    input[type="text"],input[type="number"],select{
      width:100%;background:#0e1430;color:var(--text);
      border:1px solid rgba(255,255,255,.09);border-radius:12px;padding:14px 12px;outline:none;
      transition:border-color .2s,box-shadow .2s,transform .02s;
    }
    input:focus,select:focus{border-color:var(--primary);box-shadow:0 0 0 6px var(--ring)}
    .hint{font-size:.82rem;color:var(--muted);margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{appearance:none;border:1px solid transparent;border-radius:12px;padding:12px 16px;font-weight:600;letter-spacing:.2px;cursor:pointer;transition:transform .05s,box-shadow .2s,opacity .2s}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:linear-gradient(180deg,var(--primary) 0%,var(--primary-600) 100%);color:white;box-shadow:0 12px 28px rgba(91,140,255,.28)}
    .btn-secondary{background:transparent;color:#dfe6ff;border-color:rgba(255,255,255,.14)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;font-weight:600;font-size:.9rem;border:1px solid rgba(255,255,255,.12);color:#dfe6ff;background:rgba(255,255,255,.03);cursor:pointer;user-select:none}
    .pill.is-active{border-color:var(--primary);box-shadow:0 0 0 5px var(--ring)}
    #map{height:420px;border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.08);box-shadow:var(--shadow-soft)}
    .pdf-grid{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media (max-width:980px){.pdf-grid{grid-template-columns:1fr}}
    .checks{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .check{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);padding:12px 14px;border-radius:12px;display:flex;gap:10px;align-items:center}
    .check input{width:18px;height:18px}
    table.preview{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px;margin-top:14px}
    table.preview th,table.preview td{padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.08)}
    table.preview th{text-align:left;color:#cfd7ef;font-weight:700;background:#0f1633}
    table.preview tr:last-child td{border-bottom:none}
    .total{font-weight:800;color:var(--accent)}
    .footer{margin-top:18px;color:var(--muted);font-size:.9rem;display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="page-title"><span class="emoji">✈️</span> Cotação de Voo Executivo</div>

    <div class="grid">
      <!-- Formulário -->
      <div class="card">
        <div class="card-h">Rota & Parâmetros</div>
        <div class="card-b">
          <form id="cotacaoForm">
            <div class="row">
              <div class="col-6">
                <label for="origem">Aeroporto 1 (Origem)</label>
                <input type="text" id="origem" placeholder="SBBR, SBMT...">
              </div>
              <div class="col-6">
                <label for="destino">Aeroporto 2 (Destino)</label>
                <input type="text" id="destino" placeholder="SBEG, SBGL...">
              </div>

              <div class="col-6">
                <label for="aeronave">Aeronave</label>
                <select id="aeronave">
                  <option value="">Selecione</option>
                  <option>Hawker 400</option>
                  <option>Phenom 100</option>
                  <option>Citation II</option>
                  <option>King Air C90</option>
                  <option>Seneca IV</option>
                  <option>Cirrus SR22</option>
                </select>
              </div>

              <div class="col-3">
                <label for="tarifa">R$/km</label>
                <input type="number" id="tarifa" min="0" step="0.01" placeholder="36,00">
              </div>

              <div class="col-3">
                <label>Ida/Volta?</label>
                <div class="pills" id="tipoViagem" data-mode="oneway">
                  <div class="pill is-active" data-mode="oneway">Só ida</div>
                  <div class="pill" data-mode="round">Ida e volta</div>
                </div>
              </div>

              <div class="col-6">
                <label>Ajuste</label>
                <div class="pills" id="ajusteTipo" data-ajuste="none">
                  <div class="pill is-active" data-ajuste="none">Sem ajuste</div>
                  <div class="pill" data-ajuste="add">Adicionar</div>
                  <div class="pill" data-ajuste="sub">Subtrair</div>
                </div>
                <div class="hint">“Adicionar” → Despesas acessórias · “Subtrair” → Desconto</div>
              </div>

              <div class="col-6">
                <label for="valorAjuste">Valor do ajuste (R$)</label>
                <input type="number" id="valorAjuste" min="0" step="0.01" placeholder="0,00">
              </div>
            </div>

            <div class="actions">
              <button type="button" id="btnTraçar" class="btn btn-primary">Calcular & Traçar Rota</button>
              <button type="button" id="btnPDF" class="btn btn-secondary">Gerar PDF</button>
            </div>
          </form>

          <div id="preview"></div>
        </div>
      </div>

      <!-- Mapa -->
      <div class="card">
        <div class="card-h">Mapa</div>
        <div class="card-b"><div id="map"></div></div>
      </div>

      <!-- Configuração PDF -->
      <div class="card" style="grid-column:1 / -1">
        <div class="card-h">Configuração do PDF</div>
        <div class="card-b pdf-grid">
          <div class="checks">
            <label class="check"><input type="checkbox" id="pdfMapa" checked> Incluir mapa</label>
            <label class="check"><input type="checkbox" id="pdfRota" checked> Incluir rota</label>
            <label class="check"><input type="checkbox" id="pdfDist" checked> Incluir distância</label>
            <label class="check"><input type="checkbox" id="pdfAeronave" checked> Incluir aeronave</label>
            <label class="check"><input type="checkbox" id="pdfTarifa" checked> Incluir tarifa</label>
            <label class="check"><input type="checkbox" id="pdfPernas" checked> Incluir pernas</label>
            <label class="check"><input type="checkbox" id="pdfSubtotal" checked> Incluir subtotal</label>
            <label class="check"><input type="checkbox" id="pdfAjuste" checked> Incluir ajuste</label>
            <label class="check"><input type="checkbox" id="pdfTotal" checked> Incluir total</label>
            <label class="check"><input type="checkbox" id="pdfInfo" checked> Incluir informações gerais</label>
          </div>
        </div>
      </div>

      <div class="footer">
        DADOS PARA PAGAMENTO • INTER - 077 AUTOCON SUPRIMENTOS DE INFORMATICA • CNPJ: 36.326.772/0001-65 • Agência: 0001 • Conta: 25691815-5
      </div>
    </div>
  </div>

  <script>
    // Exclusividade das pills
    function makePillsExclusive(container, attr){
      const el = document.getElementById(container);
      if(!el) return;
      el.addEventListener('click', (ev)=>{
        const pill = ev.target.closest('.pill'); if(!pill) return;
        [...el.querySelectorAll('.pill')].forEach(p=>p.classList.remove('is-active'));
        pill.classList.add('is-active');
        el.dataset[attr] = pill.dataset[attr];
      });
    }
    makePillsExclusive('tipoViagem','mode');
    makePillsExclusive('ajusteTipo','ajuste');

    // Mapa
    let map, routeLayer;
    function ensureMap(){
      if(map) return map;
      map = L.map('map').setView([-15.78,-47.93],4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap',
        crossOrigin: ''
      }).addTo(map);
      return map;
    }
    ensureMap();

    async function geocode(place){
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(place)}`;
      const r = await fetch(url);
      const data = await r.json();
      if(!data || !data.length) throw new Error('Local não encontrado');
      return {lat:parseFloat(data[0].lat), lon:parseFloat(data[0].lon)};
    }

    let ultimoCalculo = null;
    function formatMoney(n){return n.toLocaleString('pt-BR',{minimumFractionDigits:2})}

    async function calcularTrajeto(){
      const origem = document.getElementById('origem').value.trim();
      const destino = document.getElementById('destino').value.trim();
      const aeronave = document.getElementById('aeronave').value;
      const tarifa = parseFloat((document.getElementById('tarifa').value||'').replace(',', '.'));
      const tipoViagem = document.getElementById('tipoViagem').dataset.mode || 'oneway';
      const ajusteTipo = document.getElementById('ajusteTipo').dataset.ajuste || 'none';
      const valorAjuste = parseFloat((document.getElementById('valorAjuste').value||'').replace(',', '.')) || 0;

      if(!origem || !destino || !aeronave || isNaN(tarifa)){
        alert('Preencha origem, destino, aeronave e tarifa.');
        return;
      }

      ensureMap();
      try{
        const [o,d] = await Promise.all([geocode(origem), geocode(destino)]);
        if(routeLayer) { map.removeLayer(routeLayer); }
        routeLayer = L.polyline([[o.lat,o.lon],[d.lat,d.lon]], {color:'#5b8cff'}).addTo(map);
        map.fitBounds(routeLayer.getBounds().pad(0.5));
        const distOneWay = map.distance([o.lat,o.lon],[d.lat,d.lon]) / 1000; // km
        const distTotal = tipoViagem==='round' ? distOneWay*2 : distOneWay;
        const subtotal = distTotal * tarifa;
        let total = subtotal;
        if(ajusteTipo==='add') total += valorAjuste;
        if(ajusteTipo==='sub') total -= valorAjuste;

        ultimoCalculo = {origem,destino,aeronave,tarifa,distOneWay,distTotal,tipoViagem,subtotal,ajusteTipo,valorAjuste,total};

        const preview = document.getElementById('preview');
        preview.innerHTML = `<table class="preview">
          <tr><th>Origem</th><td>${origem}</td></tr>
          <tr><th>Destino</th><td>${destino}</td></tr>
          <tr><th>Aeronave</th><td>${aeronave}</td></tr>
          <tr><th>Distância</th><td>${distTotal.toFixed(1)} km</td></tr>
          <tr><th>Tarifa</th><td>R$ ${formatMoney(tarifa)}/km</td></tr>
          <tr><th>Subtotal</th><td>R$ ${formatMoney(subtotal)}</td></tr>
          ${ajusteTipo!=='none' && valorAjuste>0 ? `<tr><th>Ajuste</th><td>${ajusteTipo==='add'?'+':'-'} R$ ${formatMoney(valorAjuste)}</td></tr>`:''}
          <tr class="total"><th>Total</th><td>R$ ${formatMoney(total)}</td></tr>
        </table>`;
      }catch(e){
        alert('Erro ao traçar rota: '+e.message);
      }
    }

    async function gerarPDF(){
      if(!ultimoCalculo){
        await calcularTrajeto();
        if(!ultimoCalculo) return;
      }

      const opts = {
        mapa: document.getElementById('pdfMapa').checked,
        rota: document.getElementById('pdfRota').checked,
        dist: document.getElementById('pdfDist').checked,
        aeronave: document.getElementById('pdfAeronave').checked,
        tarifa: document.getElementById('pdfTarifa').checked,
        pernas: document.getElementById('pdfPernas').checked,
        subtotal: document.getElementById('pdfSubtotal').checked,
        ajuste: document.getElementById('pdfAjuste').checked,
        total: document.getElementById('pdfTotal').checked,
        info: document.getElementById('pdfInfo').checked
      };

      let mapaBase64 = null;
      if(opts.mapa){
        try{
          mapaBase64 = await html2canvas(document.getElementById('map'), {useCORS:true}).then(c=>c.toDataURL('image/png'));
        }catch(e){
          console.warn('Falha ao capturar mapa:', e);
        }
      }

      const c = ultimoCalculo;
      const content = [];
      if(opts.mapa && mapaBase64) content.push({image:mapaBase64,width:500,margin:[0,0,0,10]});
      if(opts.rota) content.push({text:`Rota: ${c.origem} → ${c.destino}`});
      if(opts.aeronave) content.push({text:`Aeronave: ${c.aeronave}`});
      if(opts.tarifa) content.push({text:`Tarifa: R$ ${formatMoney(c.tarifa)}/km`});
      if(opts.dist) content.push({text:`Distância total: ${c.distTotal.toFixed(1)} km`});

      if(opts.pernas){
        const legs = [
          {o:c.origem, d:c.destino, km:c.distOneWay.toFixed(1)}
        ];
        if(c.tipoViagem==='round') legs.push({o:c.destino,d:c.origem,km:c.distOneWay.toFixed(1)});
        const rows = [['Origem','Destino','Distância (km)'], ...legs.map(l=>[l.o,l.d,l.km])];
        content.push({table:{body:rows},margin:[0,10,0,10]});
      }

      if(opts.subtotal) content.push({text:`Subtotal: R$ ${formatMoney(c.subtotal)}`});
      if(opts.ajuste && c.ajusteTipo!=='none' && c.valorAjuste>0) {
        const sign = c.ajusteTipo==='add'?'+':'-';
        content.push({text:`Ajuste: ${sign} R$ ${formatMoney(c.valorAjuste)}`});
      }
      if(opts.total) content.push({text:`Total: R$ ${formatMoney(c.total)}`,bold:true,margin:[0,5,0,0]});

      if(opts.info){
        content.push({text:'Informações Gerais',style:'subheader',margin:[0,10,0,4]});
        content.push({ul:[
          'Valores estimados sujeitos à confirmação de disponibilidade.',
          'Despesas aeroportuárias e taxas podem variar.',
          'Condições meteorológicas podem alterar rotas.'
        ]});
      }

      const docDefinition = {
        content,
        styles:{subheader:{fontSize:12,bold:true}},
        defaultStyle:{fontSize:10}
      };
      pdfMake.createPdf(docDefinition).download('cotacao.pdf');
    }

    document.getElementById('btnTraçar').addEventListener('click', calcularTrajeto);
    document.getElementById('btnPDF').addEventListener('click', gerarPDF);
  </script>
</body>
</html>

